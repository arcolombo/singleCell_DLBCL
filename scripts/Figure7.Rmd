---
title: "Imaging mass cytometry reveals tumor and immune spatial and phenotypic clusters associated with clinical outcomes in diffuse large B cell lymphoma (DLBCL)"
author: "Anthony Colombo+,Monirath Hav+, Erik Gerdtsson"
date: "`r Sys.Date()`"
output: html_document
---


# {.tabset}  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup {.tabset}


### Helper Functions
```{r,eval=FALSE}
 

plot_clustering_heatmap_wrapper<-function(expr=NULL, 
  cell_clustering=NULL, cluster_merging = NULL,useMedians=TRUE,useQuantiles=FALSE,
color_clusters=NULL){
  ## cluster_merging should be character merging vector of 29 or so clusters. this is input from the ANNOTATION object.  not a matched object level.
   expr<-as.matrix(expr)
  if(useQuantiles==TRUE){
  ##max min normalization
  library(matrixStats)
  rng <- colQuantiles(expr, probs = c(0.001, 0.999))
  expr01 <- t((t(expr) - rng[, 1]) / (rng[, 2] - rng[, 1]))
  expr01[expr01 < 0] <- 0
  expr01[expr01 > 1] <- 1
  }else{
   expr01<-expr 

  }

 if(is.null(color_clusters)==TRUE){
  color_clusters <- c("#DC050C", "#FB8072", "#1965B0", "#7BAFDE", "#882E72", 
  "#B17BA6", "#FF7F00", "#FDB462", "#E7298A", "#E78AC3", 
  "#33A02C", "#B2DF8A", "#55A1B1", "#8DD3C7", "#A6761D", 
  "#E6AB02", "#7570B3", "#BEAED4", "#666666", "#999999", 
  "#aa8282", "#d4b7b7", "#8600bf", "#ba5ce3", "#808000", 
  "#aeae5c", "#1e90ff", "#00bfff", "#56ff0d", "#ffff00")
 }

  # Calculate the median expression 
  library(dplyr)
  expr_median <- data.frame(expr, cell_clustering = cell_clustering) %>%
   dplyr::group_by(cell_clustering) %>% 
    dplyr::summarize_all(funs(median))
 if(useMedians==TRUE){
  expr01_median <- data.frame(expr01, cell_clustering = cell_clustering) %>%
    group_by(cell_clustering) %>% 
    dplyr::summarize_all(funs(median))
   }else{
   expr01_median <- data.frame(expr01, cell_clustering = cell_clustering) %>%
    dplyr::group_by(cell_clustering) %>% 
   dplyr::summarize_all(funs(mean))
 }
  # Calculate cluster frequencies
  clustering_table <- as.numeric(table(cell_clustering))
   print(dim(expr_median))
  # This clustering is based on the markers that were used for the main clustering
  d <- dist(expr_median[, colnames(expr)], method = "euclidean")
  cluster_rows <- hclust(d, method = "average")
   expr_heat <- as.matrix(expr01_median[, colnames(expr01)])
  rownames(expr_heat) <- expr01_median$cell_clustering
 
  labels_row <- paste0(rownames(expr_heat), " (", 
    round(clustering_table / sum(clustering_table) * 100, 2), "%)")
  labels_col <- colnames(expr_heat)
  
  # Row annotation for the heatmap
  annotation_row <- data.frame(cluster = factor(expr01_median$cell_clustering))
  rownames(annotation_row) <- rownames(expr_heat)
  
  color_clusters <- color_clusters[1:nlevels(annotation_row$cluster)]
  names(color_clusters) <- levels(annotation_row$cluster)
  annotation_colors <- list(cluster = color_clusters)
  annotation_legend <- FALSE
  
  if(!is.null(cluster_merging)){
    
    annotation_row$cluster_merging <- factor(cluster_merging)
    color_clusters <- color_clusters[1:nlevels(factor(cluster_merging))]
    names(color_clusters) <- levels(factor(cluster_merging))
    annotation_colors$cluster_merging <- color_clusters
    annotation_legend <- TRUE
  }
  
  # Colors for the heatmap
  library(RColorBrewer);library(pheatmap)
  color <- colorRampPalette(rev(brewer.pal(n = 9, name = "RdYlBu")))(100)
  
  pheatmap::pheatmap(expr_heat, color = color, 
    cluster_cols = FALSE, cluster_rows = cluster_rows, 
    labels_col = labels_col, labels_row = labels_row, 
    display_numbers = TRUE, number_color = "black", 
    fontsize = 12, fontsize_number = 12,
    annotation_row = annotation_row, annotation_colors = annotation_colors,
    annotation_legend = annotation_legend)
  
}



mynormalize<-function(data=NULL,percentile=NULL){
   if(percentile>1){
     percentile<-percentile/100
   }
    if(is.null(percentile)==TRUE){
    minValues<-apply(data,2,min)
    maxValues<-apply(data,2,max) 
   }else{
    minValues<-apply(data,2,function(x) quantile(x,1-percentile)  )
    maxValues<-apply(data,2,function(x) quantile(x,percentile)  )
   }
    hv2<-maxValues-minValues
    dataXR<-data
    stopifnot(all( colnames(data)==names(minValues)))
    stopifnot(all(colnames(data)==names(maxValues)))
    stopifnot(all(colnames(data)==names(hv2)))
    for(j in 1:ncol(data)){
    dataXR[,j]<-(data[,j]-minValues[j])/hv2[j]
    }
    dataXR[dataXR<0]<-0
    dataXR[dataXR>1]<-1

  stopifnot(all(apply(dataXR,2,max)==1))
  stopifnot(all(apply(dataXR,2,min)==0))
   return(dataXR)
}



metaClusterPhenotype<-function(dn4=NULL,phenotype=NULL,myPheno=NULL,markers=NULL,plotPCA=FALSE,k2=15){
 #myPheno is the column for the phenotype.
    
   erik<-subset(dn4,dn4[,myPheno]==phenotype)
  ## subMeta holds the casePheno 
  dn4[,paste0(phenotype,"_subMeta")]<-NA
    erik[,paste0(phenotype,"_subMeta")]<-NA
 require(Rphenograph)
   roiData<-as.data.frame.matrix(table(erik$ROIID,erik[,myPheno]))

   for(roi in rownames(roiData)[which(roiData[,phenotype]>45)]){
     myroi<-subset(erik,erik$ROIID==roi)
     graph<-Rphenograph(myroi[,markers],k=45)
     myroi[,paste0(phenotype,"_subMeta")]<-membership(graph[[2]])
    dn4[match(myroi$uniqueLabel,dn4$uniqueLabel),paste0(phenotype,"_subMeta")]<-membership(graph[[2]])
     erik[match(myroi$uniqueLabel,erik$uniqueLabel),paste0(phenotype,"_subMeta")]<-membership(graph[[2]])
   }

  ErikMeta=erik[,
	c(markers,
	"ROIID",
	paste0(phenotype,"_subMeta"))] %>% group_by(ROIID,.dots=paste0(phenotype,"_subMeta")) %>% 
       dplyr::summarise_all(funs(median)) %>%data.frame
     
          ##Levine used k=15 for meta.
     erikPheno<- Rphenograph(ErikMeta[,c(markers)], k = k2)
     subphenograph_cluster_meta<- factor(membership(erikPheno[[2]]))
     table(subphenograph_cluster_meta)
     ErikMeta=cbind(ErikMeta, subphenograph_cluster_meta)
     ### plot PCA, label each case.  COO,  status.  ## 
   if( any(colnames(erik)== paste0(phenotype,"_subphenograph_cluster_meta"))){
     erik<-erik[,which(colnames(erik)!= paste0(phenotype,"_subphenograph_cluster_meta"))]
 } 

   myLocal=left_join(erik, ErikMeta[,c("ROIID",paste0(phenotype,"_subMeta"),"subphenograph_cluster_meta")], by = c("ROIID"))
  colnames(myLocal)[which(colnames(myLocal)=="subphenograph_cluster_meta")]<-paste0(phenotype,"_subphenograph_cluster_meta") 
  dn4[,paste0(phenotype,"_subphenograph_cluster_meta")]<-NA
  dn4[match(myLocal$uniqueLabel,dn4$uniqueLabel),paste0(phenotype,"_subphenograph_cluster_meta")]<-myLocal[,which(colnames(myLocal)==paste0(phenotype,"_subphenograph_cluster_meta"))]

  plot_clustering_heatmap_wrapper(expr=ErikMeta[,c(markers)], 
  cell_clustering=ErikMeta[,"subphenograph_cluster_meta"],
  useMedians=TRUE,
  useQuantiles=FALSE,
  color_clusters=NULL)
 return(dn4)
}

phenographToPPP<-function(case=NULL,marksCase=NULL,shift=FALSE){
 suppressPackageStartupMessages( require(spatstat))
  ##case: the case is the phenographed CSV 
  ##returns the PPP object, with marks as the original data frame.
  ##note that the window minimum is set to 0. This **SHOULD** not hopefully interfere with the spatial coordinates.
 ##this change of min 0 was necessary for clusterset function which conflicted with the window range.
  if(shift==TRUE){
  minX<-min(case[,"X_position"])
  minY<-min(case[,"Y_position"])
 case[,"X_position"]<-case[,"X_position"]-minX
 case[,"Y_position"]<-case[,"Y_position"]-minY
    mypat<-ppp(case[,"X_position"],case[,"Y_position"],c(min(case[,"X_position"]),summary(case[,"X_position"])[6]),c(min(case[,"Y_position"]),summary(case[,"Y_position"])[6]),marks=marksCase)
  ##shifting via spatstat causes non-stationary errors. FIXME: use manual shifting of coordinates prior   
 #mypat<-spatstat::shift(mypat,c(-minX,-minY))
  }else{
    #mypat<-ppp(case[,"X_position"],case[,"Y_position"],c(0,summary(case[,"X_position"])[6]),c(0,summary(case[,"Y_position"])[6]),marks=marksCase)
 mypat<-ppp(case[,"X_position"],case[,"Y_position"],c(min(case[,"X_position"]),max(case[,"X_position"])),c(min(case[,"Y_position"]),max(case[,"Y_position"])),marks=marksCase) 
 } 

 ## scale in  micrometers
   unitname(mypat)<-"micrometer"

  return(mypat)
 }

 #### borrowing from Vito's pipeline.
  findSecondObjectNumber<-function(pp=NULL,minDistance=13.5){
  ##FIX ME : use apply nbhd
   x<-pairdist(pp)
    id<-apply(x,1,function(x) which(x<=minDistance))
  ##stack the list into long format
  names(id)<-as.character(seq(1,npoints(pp)))
  datRel<-stack(id)
 ##the second object near the first fixed object.
  colnames(datRel)<-c("Second Object Number","First Object Number")
   ##exclude self
   datRel<-datRel[which(datRel[,"First Object Number"]!=datRel[,"Second Object Number"]),]
   datRel[,1]<-as.numeric(datRel[,1])
  datRel[,2]<-as.numeric(datRel[,2])
   return(datRel)
  }



 findROIinteraction<-function(p1=NULL,
	firstLabel=NULL,
	secondLabel=NULL){
   ii<-p1[which(p1[,"FirstLabel"]==firstLabel & p1[,"SecondLabel"]==secondLabel),]
  return(ii)
 }

 createRelationTable<-function(dn5=NULL,myPheno=NULL,minDistance=12){
  ##for each ROI, create PPP
  dat_relation2<-c()
  for(roi in unique(dn5$ROIID)){
   message(roi)
   dats<-subset(dn5,dn5$ROIID==roi)
   synth3.cells<-phenographToPPP(case=dats,marks=factor(dats[,myPheno]))
   dat_relation<-findSecondObjectNumber(pp=synth3.cells,minDistance=minDistance)
  dat_relation$Relationship<-"Neighbors"
  dat_relation[,"First Object Name"]<-"cell"
  dat_relation[,"First Image Number"]<-roi
  dat_relation[,"Second Object Name"]<-"cell"
  dat_relation[,"Second Image Number"]<-roi
  dat_relation2<-rbind(dat_relation2,dat_relation)
  }
 return(data.table(dat_relation2))
}



makePermutationNBHD<-function(dat_cells=NULL,dat_relation=NULL,n_perm=100,pthreshold=0.05){
  d = prepare_tables(dat_cells, dat_relation)
  dat_baseline = apply_labels(d[[1]], d[[2]]) %>%
  aggregate_histo()


 set.seed(12312)
   dat_perm = rbindlist(mclapply(1:n_perm, function(x){
  dat_labels = shuffle_labels(d[[1]])
  apply_labels(dat_labels, d[[2]]) %>%
    aggregate_histo()
  },mc.cores = 1
  ), idcol = 'run') 
 
   dat_p <- calc_p_vals(dat_baseline, dat_perm, n_perm = n_perm, p_tresh = pthreshold) 
 ### plotting heatmap.
  
   pmat = dcast(dat_p, 'FirstLabel ~ SecondLabel', value.var = 'sigval', fun.aggregate = sum,
             fill=0, drop=F)
   rname = pmat$FirstLabel
   pmat<-as.data.table(pmat)
   pmat = pmat[,which(colnames(pmat)!="FirstLabel"),with=FALSE] %>%
    as.matrix()
row.names(pmat) <- rname
 ### he structures his probabilities greater than and less than.
  return(list(pmat=pmat,dat_p=dat_p))
 }

## Vito Methodology.
 performVitoInteraction<-function(full.dn4.5nn2=NULL,phenotypeColumn=NULL,saveName=NULL,minDistance=15){
  zz<-full.dn4.5nn2
 table(zz[,phenotypeColumn])
   ### Vito's spatial analysis subtypes.
  dat_cells<-data.frame(ImageNumber=zz$ROIID,
	ObjectNumber=zz$CellId,
	label=as.character(zz[,phenotypeColumn]),
	group=zz$ROIID)
  dat_cells<-data.table(dat_cells)
  dat_relation<-createRelationTable(dn5=zz,myPheno=phenotypeColumn,minDistance=minDistance)
 save(dat_relation,file=paste0("dat_relation_",minDistance,"_",saveName,".RData"))

  p1<-makePermutationNBHD(dat_cells=dat_cells,dat_relation=dat_relation,n_perm=1000)
  save(p1,file=paste0("p1_",minDistance,"_",saveName,".RData"))
   require(pheatmap)
  cols = rev(brewer.pal(11,'Spectral'))
  cmap = colorRampPalette(cols)
  hr <- hclust(dist(p1$pmat), method="ward.D")
     pheatmap(p1$pmat, 
	color = cmap(25), 
    cluster_cols = TRUE, 
    cluster_rows = TRUE, 
    labels_col = colnames(p1),
    labels_row = colnames(p1), 
    display_numbers = TRUE,  
    fontsize = 14,
    cutree_rows=2,
	cutree_cols=2)

  return(p1)
}

getExperimentColors<-function(){
  cd4s<-colorRampPalette(c("khaki1","plum2"),10)
  cd4s<-cd4s(2)
 names(cd4s)<-c("DLBCL","HD")
  return(cd4s)
}

distanceCalculationROI<-function(synth=NULL,zz=NULL,cluster.column="cd8.case.cluster"){
  require(Rphenograph)
  nnd1<-grabDistanceRange(synth,uniqueLabel=zz$uniqueLabel,k=1)
    nnd2<-grabDistanceRange(synth,uniqueLabel=zz$uniqueLabel,k=2)
  nnd3<-grabDistanceRange(synth,uniqueLabel=zz$uniqueLabel,k=3)
  nnd4<-grabDistanceRange(synth,uniqueLabel=zz$uniqueLabel,k=4)
  nnd5<-grabDistanceRange(synth,uniqueLabel=zz$uniqueLabel,k=5)
  #nnd6<-grabDistanceRange(synth,uniqueLabel=zz$uniqueLabel,k=6)
  #nnd7<-grabDistanceRange(synth,uniqueLabel=zz$uniqueLabel,k=7)
  #nnd8<-grabDistanceRange(synth,uniqueLabel=zz$uniqueLabel,k=8)
  
  ## assemble
  nnd<-cbind(nnd1[,grepl("k_",colnames(nnd1))],
	nnd2[,grepl("k_",colnames(nnd2))],
	nnd3[,grepl("k_",colnames(nnd3))],
	nnd4[,grepl("k_",colnames(nnd4))],
	nnd5[,grepl("k_",colnames(nnd5))])
	#nnd6[,grepl("k_",colnames(nnd6))],
	#nnd7[,grepl("k_",colnames(nnd7))],
	#nnd8[,grepl("k_",colnames(nnd8))])
    nnd$uniqueLabel<-zz$uniqueLabel
    nnd$marks<-marks(synth)
   stopifnot(all(nrow(nnd)==nrow(zz)))
     nnd$ROIID<-zz$ROIID
    nnd$cluster<-zz[,cluster.column]
  return(nnd)
}


grabDistanceRange<-function(synth=NULL,uniqueLabel=NULL,k=1,from=NULL,to=NULL){
  nnd<-as.data.frame(nndist(synth,k=k,by=marks(synth)))
  colnames(nnd)<-paste0("k_",k,"_",colnames(nnd))
  for(i in 1:ncol(nnd)){
  nnd[which(is.infinite(nnd[,i])),i] <-300
 }##
   nnd$marks<-marks(synth)
   nnd$K=1
   nnd$uniqueLabel<-uniqueLabel 
  return(nnd)
  }

 findFirstNearestNeighbor<-function(dn4=NULL,myPheno="tumor.5nn.class.unsup",from="Tumor_d",to="CD4_1",k=1){
   NND<-c()
  for(roi in unique(dn4$ROIID)){
  message(roi)
  myRoi<-subset(dn4,dn4$ROIID==roi)
  myRoi[,myPheno]<-factor(myRoi[,myPheno])
   pipi<-phenographToPPP(case=myRoi,marksCase=myRoi[,c(myPheno,'uniqueLabel')],shift=FALSE)
  all(coords(pipi)[,1]==myRoi$X_position)
  all(coords(pipi)[,2]==myRoi$Y_position)
  types<-split(pipi,marks(pipi)[,myPheno])
 
  if(is.null(types[[from]]) |is.null(types[[to]])){
  message('skipping')
  next
 } ## if check.
   ##construct convex hull 1 NN
 ## for each tumor cell,identify 5 NN immune/stroma cells.
 ##describes how immune/stroma surround tumor.
  nnd<-cbind(nncross(types[[from]],types[[to]],k=k))
  nnd$ROIID<-roi
  nnd$from<-from
	nnd$to<-to
	nnd$uniqueLabel<-marks(types[[from]])$uniqueLabel
  NND<-rbind(NND,nnd)
 }## For loop
  return(NND)
  }##main





```

### Library
```{r,eval=FALSE}

 library(data.table)
library(dplyr)
library(magrittr)
library(dtplyr)
library(ggplot2)
library(parallel)
library(neighbouRhood)
library(gplots)
library(RColorBrewer)
 library(hrbrthemes)
```

### Label the cHL phenotypes
```{r,eval=FALSE}
 load("~/Documents/imageAnalysis/steidl/steidl-spatialAnalysis9-11/fold-revised-10-5/dn4.final.foldRevised.RData")

 hd.lineage<-c( "CD11b",
                       "CD11c",
                       "CD14",
                       "CD15",
                       "CD16",
                       "CD206",
			"CD20",
			"CD30",
			"CD34",
			"CD3",
			"CD45RA",
			"CD45RO",
			"CD4",
			"CD68",
			"CD8a",
                       "FOXP3",
			"EphrinB2",
			"Eccentricity",
			"Area",
			"DNA1",
			"DNA2") 
 hd.induc<-c("X41BB",
		"CCR4",
		"CXCR3",
		"CXCR5",
		"Caspase3",
		"GATA3",
		"HLAABC",
		"HLADR",
		"ICOS",
		"IDO",
		"Ki67",
		"LAG3",
		"NKG2D",
		"PD1",
		"PDL1",
		"TIM3",
		"Tbet")
  morphs<-mynormalize(data=dn4[,c("Area",
	"Eccentricity")],percentile=0.99)

  dn4$Area<-morphs$Area
  dn4$Eccentricity<-morphs$Eccentricity
  
      plot_clustering_heatmap_wrapper(expr=dn4[,c(hd.lineage,hd.induc)], 
  cell_clustering=dn4[,"spatial.annotation"], 
	cluster_merging = NULL,useMedians=TRUE)


  ### meta-cluster each phenotype to identify sub-populations.
    
########### META-CLUSTER EACH POPULATION ############################
 ##meta-cluster the tumor population
   dn4<-metaClusterPhenotype(dn4=dn4,
	phenotype="CD30.HRS",
	myPheno="spatial.annotation",
	markers=c(hd.lineage,hd.induc))

  ## CD8
   dn4<-metaClusterPhenotype(dn4=dn4,
	phenotype="CD8",
	myPheno="spatial.annotation",
	markers=c(hd.lineage,hd.induc))

 ## CD4
  dn4<-metaClusterPhenotype(dn4=dn4,
	phenotype="CD4",
	myPheno="spatial.annotation",
	markers=c(hd.lineage,hd.induc))

  ## TREG
  dn4<-metaClusterPhenotype(dn4=dn4,
	phenotype="TREG",
	myPheno="spatial.annotation",
	markers=c(hd.lineage,hd.induc))

 ## MAC
 dn4<-metaClusterPhenotype(dn4=dn4,
	phenotype="Macrophage",
	myPheno="spatial.annotation",
	markers=c(hd.lineage,hd.induc))

  
 ## annotate the clusters
      plot_clustering_heatmap_wrapper(expr=dn4[which(dn4$spatial.annotation=='CD30.HRS'),c(hd.lineage,hd.induc)], 
 cell_clustering=dn4[which(!is.na(dn4$CD30.HRS_subphenograph_cluster_meta)),"CD30.HRS_subphenograph_cluster_meta"], 
	cluster_merging = NULL,useMedians=TRUE)

 dn4$unsup.subcommunity<-as.character(dn4$spatial.annotation)
 #HRS
 dn4$unsup.subcommunity[which(!is.na(dn4$CD30.HRS_subphenograph_cluster_meta))]<-paste0("CD30.HRS_",dn4[which(!is.na(dn4$CD30.HRS_subphenograph_cluster_meta)),"CD30.HRS_subphenograph_cluster_meta"])
 #MAC
 dn4$unsup.subcommunity[which(!is.na(dn4$Macrophage_subphenograph_cluster_meta))]<-paste0("Macrophage_",dn4[which(!is.na(dn4$Macrophage_subphenograph_cluster_meta)),"Macrophage_subphenograph_cluster_meta"])
 ##TREG
dn4$unsup.subcommunity[which(!is.na(dn4$TREG_subphenograph_cluster_meta))]<-paste0("TREG_",dn4[which(!is.na(dn4$TREG_subphenograph_cluster_meta)),"TREG_subphenograph_cluster_meta"])
 ## CD8
dn4$unsup.subcommunity[which(!is.na(dn4$CD8_subphenograph_cluster_meta))]<-paste0("CD8_",dn4[which(!is.na(dn4$CD8_subphenograph_cluster_meta)),"CD8_subphenograph_cluster_meta"])
## CD4
dn4$unsup.subcommunity[which(!is.na(dn4$CD4_subphenograph_cluster_meta))]<-paste0("CD4_",dn4[which(!is.na(dn4$CD4_subphenograph_cluster_meta)),"CD4_subphenograph_cluster_meta"])
 
  zz<- zScorePatientExpression(full.dn4=full.dn4,markers=c(1:31,104:111),ROIID.column=32) 


## heatmap

 
### calculate any expression differences across sub-clusters and treatment response.
      zz<- zScorePatientExpression(full.dn4=dn4,markers=c(1:36,41:42),ROIID.column=37)

  communityExp3<-zz%>%group_by(unsup.subcommunity)%>%dplyr::summarise(TIM3=mean(TIM3),
	LAG3=mean(LAG3),
	PD1=mean(PD1),
	ICOS=mean(ICOS),
	PDL1=mean(PDL1),
	CCR4=mean(CCR4),
	CXCR3=mean(CXCR3),
	CXCR5=mean(CXCR5),
	GATA3=mean(GATA3),
	IDO=mean(IDO),
	Tbet=mean(Tbet),
	CD4=mean(CD4),
	CD8=mean(CD8a),	
	CD68=mean(CD68),
	CD14=mean(CD14),
	CD15=mean(CD15),
	CD16=mean(CD16),
	CD11b=mean(CD11b),
	CD11c=mean(CD11c),
	CD30=mean(CD30),
	FOXP3=mean(FOXP3),
	CD20=mean(CD20),	
	CD206=mean(CD206),
	Ki67=mean(Ki67),
	CD45RO=mean(CD45RO),
	CD45RA=mean(CD45RA))%>%data.frame

 ##omit tumor_11 cluster after we measured NND tumor
  communityExp3<-communityExp3[which(!is.na(communityExp3[,1])),]
   stateExp<-t(communityExp3[,-1])
  colnames(stateExp)<-communityExp3[,1]
 labelHeat<-Heatmap(stateExp)
 labelHeat

  anno<-data.frame(cluster=unique(dn4$unsup.subcommunity),label='none')
  anno<-anno[match(colnames(stateExp)[labelHeat@column_order],anno$cluster),]

  
 anno$label<-c("BCell",
	"CD30+ HRS",
	"PD-L1+CD30+ HRS",
	"PD-L1+CD30+ HRS",
	"CD30+ HRS",
	"PD-L1+CD30+ HRS",
	"CD30+ HRS",
	"CD30+ HRS",
	#CD4
	"PD-1+ memory CD4",
	"Memory CD4",
	"PD-1+ memory CD4",
	"LAG-3+ CD4",
	"Memory CD4",
	"Memory CD4",
	"Memory CD4",
	"PD-1+ memory CD4",
	"LAG-3+ CD4",
	"Memory CD4",
	#CD8
	rep("CD8",9),
	"Dendritic",
	#MAC
	"PD-L1+M2 macrophage",
	"M1-macrophage",
	"M1-macrophage",
	"PD-L1+M2 macrophage",
	"PD-L1+M2 macrophage",
 	"PD-L1+M2 macrophage",
	"M2-macrophage",
	"PD-L1+M2 macrophage",
	"M2-macrophage",
	#TREG
	'Myeloid',
	'TREG',
	'Ki67+ TREG',
	'Ki67+ TREG',
	'LAG-3+ TREG',
	'CCR4+ TREG',
	'LAG-3+ TREG',
	'CXCR3+LAG-3+ TREG')

 ## easyLabel
 anno$easyLabel<-gsub("\\+","_",anno$label)
 anno$easyLabel<-gsub("\\-","",anno$easyLabel)
 anno$easyLabel<-gsub(" ","",anno$easyLabel)
 ## key into hte main data.
   dn4$annotated.label<-anno$label[match(dn4$unsup.subcommunity,anno$cluster)]
   dn4$annotated.label.simple<-anno$easyLabel[match(dn4$unsup.subcommunity,anno$cluster)]
 zz$annotated.label<-anno$label[match(zz$unsup.subcommunity,anno$cluster)]
   zz$annotated.label.simple<-anno$easyLabel[match(zz$unsup.subcommunity,anno$cluster)]

 communityExp3<-zz%>%group_by(annotated.label)%>%dplyr::summarise(TIM3=mean(TIM3),
	LAG3=mean(LAG3),
	PD1=mean(PD1),
	ICOS=mean(ICOS),
	PDL1=mean(PDL1),
	CCR4=mean(CCR4),
	CXCR3=mean(CXCR3),
	CXCR5=mean(CXCR5),
	GATA3=mean(GATA3),
	IDO=mean(IDO),
	Tbet=mean(Tbet),
	CD4=mean(CD4),
	CD8=mean(CD8a),	
	CD68=mean(CD68),
	CD14=mean(CD14),
	CD15=mean(CD15),
	CD16=mean(CD16),
	CD11b=mean(CD11b),
	CD11c=mean(CD11c),
	CD30=mean(CD30),
	FOXP3=mean(FOXP3),
	CD20=mean(CD20),	
	CD206=mean(CD206),
	Ki67=mean(Ki67),
	CD45RO=mean(CD45RO),
	CD45RA=mean(CD45RA))%>%data.frame

 ##omit tumor_11 cluster after we measured NND tumor
  communityExp3<-communityExp3[which(!is.na(communityExp3[,1])),]
   stateExp<-t(communityExp3[,-1])
  colnames(stateExp)<-communityExp3[,1]
 labelHeat<-Heatmap(stateExp)
 labelHeat


		
 
   

```


### spatial interactions

```{r,eval=FALSE}

 chl<-dn4[which(dn4$diagnosis=='HDLR' | dn4$diagnosis=='HDMC'),]
 chl$diagnosis<-droplevels(chl$diagnosis)

  dat_cells<-data.frame(ImageNumber=chl$ROIID,
	ObjectNumber=chl$CellId,
	label=as.character(chl$annotated.label.simple),
	group=chl$ROIID)
  dat_cells<-data.table(dat_cells)
  dat_relation_15<-createRelationTable(dn5=chl,
	myPheno="annotated.label.simple",
	minDistance=15)
  save(dat_relation_15,file="dat_relation_15_CHL.simple.label.15distance.RData")
 load("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/chl-spatial/dat_relation_15_CHL.simple.label.15distance.RData")

  
 ## using the p=0.01 threshold.
  p1<-makePermutationNBHD(dat_cells=dat_cells,
	dat_relation=dat_relation_15,
	n_perm=1000,pthreshold=0.025)
 chl.p1<-p1

  save(chl.p1,file="~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/chl-spatial/chl.p1_15_CHL_annotatedLabel.simple.label.15distance.025.RData")
  


 ## chl
 interact<-chl.p1$pmat
 

 require(dendsort);require(pvclust)
  rpt.pv<-pvclust(interact[,!grepl("Tumor",colnames(interact))],nboot=100,method.hclust="average")
  rpt.dend<-dendsort(hclust(dist(interact[,!grepl("Tumor",colnames(interact))])),isReverse=TRUE)
  library(ComplexHeatmap);library(dendextend)
  
  inth<-Heatmap(interact[,!grepl("Tumor",colnames(interact))],
                  cluster_rows=rpt.dend,
                  cluster_columns=rpt.pv$hclust,
		name="Immune interaction Z-score",
		rect_gp = gpar(col = "white", lwd = 1))




```


### TME neighborhood summary
 We look at the TREG in the neighborhood of PDL1+HRS/HRS, and also show the TREGs are not 
```{r,eval=FALSE}
### we analyze and summarize Bodenmiller's independent testing.
 ################################################################
  ## bar plot of interactions.
  ## TME interaction as the prmiary with the tumor (second).
 ## note that the interaction scores are proportion averages relative to the total interactions for the FirstLabel (scaled).
 p1<-chl.p1
  ints<- as.data.frame(p1$pmat)
  totalPrimary<-ints[grepl("TREG",rownames(ints)),!grepl("TREG_",colnames(ints))]
  totalPrimary$annotation<-rownames(totalPrimary)
  totalPrimary$annotation<-dn4$annotated.label[match(totalPrimary$annotation,dn4$annotated.label.simple)]


 totalPrimary2<-totalPrimary%>%group_by(annotation)%>%summarise_all(funs(sum))%>%data.frame
    rownames(totalPrimary2)<-totalPrimary2[,1]
  totalPrimary2<-totalPrimary2[,-1]
  ## using the proportion of interactions as a percent.
  totalPrimary2<-100*totalPrimary2/length(unique(chl$case))

 ### confidence intervals
 sdPrim<-apply(totalPrimary2,2,sd)%>%data.frame
 sdPrim<-as.data.frame(t(sdPrim))
  ## confidence interval. 95%
 sdPrim<- sdPrim/sqrt(ncol(sdPrim))
 error<- qt(0.975,df=ncol(sdPrim)-1)*sdPrim

 
 ## the total CD4 (firstLabel) interactions with each tumor
  totalPrimary2$primary<-rownames(totalPrimary2)
  lower<-totalPrimary2[,colnames(error)]-t(error)
  lower$primary<-rownames(lower)
 lower<-reshape2::melt(lower)
 upper<-totalPrimary2[,colnames(error)]+t(error)
   upper$primary<-rownames(upper)
 upper<-reshape2::melt(upper)
  tp<-melt(totalPrimary2)
 all(tp$variable==lower$variable)
  tp$lower<-lower$value
  tp$upper<-upper$value
  tp$upper[which(tp$value==0)]<-0
  tp$lower[which(tp$value==0)]<-0
  tp$primary<-factor(tp$primary,levels=c("TREG","Ki67+ TREG","LAG-3+ TREG","CXCR3+LAG-3+ TREG","CCR4+ TREG"))
  tp$annotate<-as.character(tp$variable)
  tp$annotate<-dn4$annotated.label[match(tp$annotate,dn4$annotated.label.simple)]
 ggplot(tp,aes(x=primary,y=value,fill=primary))+geom_bar(stat='identity')+geom_errorbar(aes(ymin=lower,ymax=upper),width=0.5)+facet_wrap(~annotate)+theme_ipsum(base_family="Arial")+theme(axis.text.x = element_text(angle = 90, hjust = 1,colour='black',size=14),
	axis.text.y=element_text(size=14,colour='black'),
	axis.title.y=element_text(size=14))+ylab("Signif. signed interactions (%)")+xlab("T-reg")+ggtitle("T-reg neighborhood total (N=10)")+scale_fill_manual(values=c('black','gray29','gray49','gray78','tan3','khaki1'))+geom_hline(yintercept=0,color='red',linetype='dashed')

ggsave("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/chl-spatial/TREG.neighborhood.png")

  labelHeat
 savePlot(file="~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/chl-spatial/labeled.heatmap.CHL.annotated.png")
  Heatmap(interact,column_title='cHL spatial interactions (p=0.025)')
 savePlot(file="~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/chl-spatial/interaction.heatmap.CHL.annotated.png")


 ## short neighborhood on B-cell and HRS.

ggplot(tp[tp$annotate%in%c("BCell","CD30+ HRS","PD-L1+CD30+ HRS"),],aes(x=primary,y=value,fill=primary))+geom_bar(stat='identity')+geom_errorbar(aes(ymin=lower,ymax=upper),width=0.5)+facet_wrap(~annotate)+theme_ipsum(base_family="Arial")+theme(axis.text.x = element_text(angle = 45, hjust = 1,colour='black',size=19),
	axis.title.x=element_text(size=13,colour='black'),
	axis.text.y=element_text(size=14,colour='black'),
	axis.title.y=element_text(size=14))+ylab("Signif. signed interactions")+xlab("T-reg")+ggtitle("T-reg neighborhood in cHL TME (N=10)")+scale_fill_manual(values=c('black','gray29','gray49','gray78','tan3','khaki1'))+geom_hline(yintercept=0,color='red',linetype='dashed')

ggsave("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/chl-spatial/TREG.neighborhood.TREG.tumor.png")

 


```
### T-reg nearest neighbor distance cross-cohort analysis
```{r,eval=FALSE}
 dn4$annotated.label.simple[which(is.na(dn4$annotated.label.simple))]<-'Endothelial'

  ## compute nearest distance from TREG to HRS.
 roiDist<-as.data.frame(matrix(150,nrow=nrow(dn4),ncol=length(unique(dn4$annotated.label.simple))))
    colnames(roiDist)[1:length(unique(dn4$annotated.label.simple))]<-paste0("k_1_",unique(dn4$annotated.label.simple)) 
 roiDist$uniqueLabel<-dn4$uniqueLabel
  roiDist$ROIID<-dn4$ROIID
  roiDist$cluster<-roiDist$marks<-'none'

  for(roi in unique(dn4$ROIID)){
  message(roi)
  myroi<-subset(dn4,dn4$ROIID==roi)
    p<-phenographToPPP(case=myroi,marksCase=factor(myroi$annotated.label.simple),shift=FALSE)
   myroi2<-distanceCalculationROI(synth=p,zz=myroi,cluster.column="annotated.label.simple")
    myroi3<-myroi2[,grepl("k_1_",colnames(myroi2))]
  myroi3$uniqueLabel<-myroi2$uniqueLabel
   myroi3$marks<-as.character(myroi2$marks)
   myroi3$ROIID<-myroi2$ROIID
  myroi3$cluster<-factor(as.character(myroi2$cluster))
  roiDist[match(myroi3$uniqueLabel,roiDist$uniqueLabel),colnames(myroi3)]<-myroi3
 }
  ##spot checking my code: from a given phenotype toward the selected PDL1M2
   P<-split(p)
  all(nncross(P[["LAG3_TREG"]],P[["CD30_HRS"]])$dist-myroi2[which(myroi2$marks=='LAG3_TREG'),'k_1_CD30_HRS']==0)

  dn4<-left_join(dn4,roiDist,by=c("ROIID","uniqueLabel"))
 save(dn4,file='dn4.fullAoki.labeled.RData')

 tregs<-subset(dn4,dn4$spatial.annotation=='TREG')
treg.nnd<-tregs%>%group_by(annotated.label.simple,case)%>%summarise(CD30.HRS=mean(k_1_CD30_HRS),PDL1.HRS=mean(k_1_PDL1_CD30_HRS))%>%data.frame
 treg.nnd$diagnosis<-dn4$diagnosis[match(treg.nnd$case,dn4$case)]



 ## dlbcl
 ##load the DLBCL data.
 
 load(file="~/Documents/imageAnalysis/DLBCL/monirath/myData/revision-comments-11-6/survival-analysis-morphological-variants/PDL1-neighborhood-analysis/workingDir/re-phenotype/full.dn4.subType.corrected.mutation.tsne.CD20dim.appended.un.filtered.RData")

 tregs.dlbcl<-subset(full.dn4,full.dn4$subType.correction=='TREG')
treg.dlbcl.nnd<-tregs.dlbcl%>%group_by(tumor.5nn.umap.simple.label,case)%>%summarise(tumor=mean(NND.Tumor))%>%data.frame


 ### DLBCL
  fit<- lm(tumor~0+tumor.5nn.umap.simple.label,treg.dlbcl.nnd)
   dlbcl.fit<-cbind(confint(fit),coef(fit))
   colnames(dlbcl.fit)<-c("lwr","upr","estimate")
  dlbcl.fit<-as.data.frame(dlbcl.fit)
   dlbcl.fit$phenotype<-c("Highly suppressive T-reg","Ki67+ T-reg","T-reg")
  dlbcl.fit$disease='DLBCL'
 ### CHL
  chl.nnd<-treg.nnd[treg.nnd$diagnosis%in%c("HDNS","HDMC"),]
  chl.nnd$tumor<-150
   chl.nnd$tumor[which(chl.nnd[3]!=150)]<-chl.nnd$CD30.HRS[which(chl.nnd$CD30.HRS!=150)]
chl.nnd$tumor[which(chl.nnd[,4]!=150)]<-chl.nnd$PDL1.HRS[which(chl.nnd$PDL1.HRS!=150)]

  chl.fit<- lm(tumor~0+annotated.label.simple,chl.nnd)
   chl.fit.dist<-cbind(confint(chl.fit),coef(chl.fit))

 colnames(chl.fit.dist)<-c('lwr','upr','estimate')
 chl.fit.dist<-as.data.frame(chl.fit.dist)
 chl.fit.dist$phenotype<-c("Highly suppressive T-reg",
	"Highly suppressive T-reg","Ki67+ T-reg","Highly suppressive T-reg","T-reg")
   chl.fit.dist<-chl.fit.dist%>%group_by(phenotype)%>%summarise_all(funs(mean))%>%data.frame

  chl.fit.dist$disease<-"HL"


  joint.treg<-as.data.frame(rbind(chl.fit.dist,dlbcl.fit))
 joint.treg$phenotype<-factor(joint.treg$phenotype,levels=unique(joint.treg$phenotype[order(joint.treg$estimate)]))
  joint.treg$lwr[which(joint.treg$lwr<0)]<-0
 exCol<-getExperimentColors()
 names(exCol)<-c("DLBCL","HL")

  SoilSciGuylabs <- c(expression("Highly suppressive "*T["REG"]),
	 expression("Ki67+ "*T["REG"]"),
	expression(T["REG"]))


jointTREG<-ggplot(joint.treg,aes(x=phenotype,y=estimate,fill=disease))+geom_bar(stat='identity',position=position_dodge())+geom_errorbar(aes(ymin=lwr,ymax=upr),position=position_dodge())+scale_fill_manual(values=exCol)+ylab(expression(T["REG"]*" nearest tumor distance ("*mu* "m)"))+theme_ipsum(base_family='Arial')+theme(axis.title.x=element_text(size=15),
 	axis.title.y=element_text(size=19),
	axis.text.x=element_text(size=18,colour='black'),
	axis.text.y=element_text(size=18,colour='black'))+xlab(expression(T["REG"]*"  phenotypes"))
 jointTREG
	
 ggsave("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/chl-spatial/TREG.NND.tumor.png")

	



```

### Gating spatial interaction analysis
We gate TIM3+/-, PD1+/-, PDL1+/- immune populations and want to compare interactions from tumor within 2-3 cell diameters.
```{r,eval=FALSE}

load("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/chl-spatial/dn4.fullAoki.labeled.RData")
   library(Hmisc)
 ## cut for TIM3
  dn4$TIM3.cut<-cut2(dn4$TIM3,g=3)
  dn4$TIM3.class<-'TIM3.low'
  dn4$TIM3.class[which(dn4$TIM3.cut=='[0.205,0.341)')]<-'TIM3.medium'
  dn4$TIM3.class[which(dn4$TIM3.cut=='[0.341,1.000]')]<-'TIM3.high'
 ##PDL1
  dn4$PDL1.cut<-cut2(dn4$PDL1,g=3)
  dn4$PDL1.class<-'PDL1.low'
  dn4$PDL1.class[which(dn4$PDL1.cut=='[0.223,0.366)')]<-'PDL1.medium'
  dn4$PDL1.class[which(dn4$PDL1.cut=='[0.366,1.000]')]<-'PDL1.high'

  dn4$PD1.cut<-cut2(dn4$PD1,g=3)
  dn4$PD1.class<-'PD1.low'
  dn4$PD1.class[which(dn4$PD1.cut=='[0.0895,0.1875)')]<-'PD1.medium'
  dn4$PD1.class[which(dn4$PD1.cut=='[0.1875,1.0000]')]<-'PD1.high'

 ##used for gating Highlysuppressive TREG.
 dn4$CCR4.cut<-cut2(dn4$CCR4,g=3)
  dn4$CCR4.class<-'CCR4.low'
  dn4$CCR4.class[which(dn4$CCR4.cut=='[0.183,0.332)')]<-'CCR4.medium' 
  dn4$CCR4.class[which(dn4$CCR4.cut=='[0.332,1.000]')]<-'CCR4.high'
 
 ##ICOS
  dn4$ICOS.cut<-cut2(dn4$ICOS,g=3)
  dn4$ICOS.class<-'ICOS.low'
  dn4$ICOS.class[which(dn4$ICOS.cut=='[0.0682,0.1655)')]<-'ICOS.medium' 
  dn4$ICOS.class[which(dn4$ICOS.cut=='[0.1655,1.0000]')]<-'ICOS.high'
 
 ## create a immune subset tag.
 dn4$immune.tag<-as.character(dn4$spatial.annotation)
 # TIM3/PDL1 co-express
 dn4$immune.tag[which(dn4$immune.tag=='Macrophage')]<-paste0(dn4$immune.tag[which(dn4$immune.tag=='Macrophage')],"_",dn4$TIM3.class[which(dn4$immune.tag=='Macrophage')],
	"_",dn4$PDL1.class[which(dn4$immune.tag=='Macrophage')])

 ##TIM3/PD1 coexpress on CD4/CD8
 dn4$immune.tag[which(dn4$immune.tag=='CD4')]<-paste0(dn4$immune.tag[which(dn4$immune.tag=='CD4')],"_",dn4$TIM3.class[which(dn4$immune.tag=='CD4')],
	"_",dn4$PD1.class[which(dn4$immune.tag=='CD4')])
 dn4$immune.tag[which(dn4$immune.tag=='CD8')]<-paste0(dn4$immune.tag[which(dn4$immune.tag=='CD8')],"_",dn4$TIM3.class[which(dn4$immune.tag=='CD8')],
	"_",dn4$PD1.class[which(dn4$immune.tag=='CD8')])

 ## TREG identify highly suppressive, and normal TREG.

 hst.id<-which(dn4$immune.tag=='TREG'&dn4$CCR4.class=='CCR4.high' & dn4$ICOS.class=='ICOS.high')
  dn4$immune.tag[hst.id]<-'HighlysuppressiveTREG'
dn4$immune.tag[which(dn4$immune.tag=='HighlysuppressiveTREG')]<-paste0(dn4$immune.tag[which(dn4$immune.tag=='HighlysuppressiveTREG')],
	"_",dn4$PD1.class[which(dn4$immune.tag=='HighlysuppressiveTREG')])
 ## TREG PD1+/med/-
 dn4$immune.tag[which(dn4$immune.tag=='TREG')]<-paste0(dn4$immune.tag[which(dn4$immune.tag=='TREG')],
	"_",dn4$PD1.class[which(dn4$immune.tag=='TREG')])

 
 save(dn4,file="~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/chl-spatial/dn4.fullAoki.labeled.RData")

 ## create the vito interactions.
 ##omit RLN.
 dn4<-dn4[which(dn4$diagnosis%in%c("HDLR","HDMC","HDNS")),]
 dn4<-dn4[which(dn4$immune.tag!='BCell'),]
  dn4<-dn4[which(dn4$immune.tag!='Dendritic'),]
   dn4<-dn4[which(dn4$immune.tag!='Myeloid'),]

  dat_cells<-data.frame(ImageNumber=dn4$ROIID,
	ObjectNumber=dn4$CellId,
	label=as.character(dn4$immune.tag),
	group=dn4$ROIID)
  dat_cells<-data.table(dat_cells)
  dat_relation_15<-createRelationTable(dn5=dn4,
	myPheno="immune.tag",
	minDistance=15)
  save(dat_relation_15,file="dat_relation_15_CHL.immune.tag.15distance.p025.RData")

 load("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/final-figure3-tables-figures-4-28/dat_relation_15_annotated.umap.simple.15distance.p025.RData")

  
 ## using the p=0.025 threshold.
  p1<-makePermutationNBHD(dat_cells=dat_cells,
	dat_relation=dat_relation_15,
	n_perm=1000,pthreshold=0.025)

  save(p1,file="~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/final-figure3-tables-figures-4-28/p1_15_annotated.chl.immune.tag.15distance.025.RData")
  


 ## Cut the same way for DLBCL.

 load(file="~/Documents/imageAnalysis/DLBCL/monirath/myData/revision-comments-11-6/survival-analysis-morphological-variants/PDL1-neighborhood-analysis/workingDir/re-phenotype/full.dn4.subType.corrected.mutation.tsne.CD20dim.appended.un.filtered.RData")
 
 library(Hmisc)
  full.dn4$TIM3.cut<-cut2(full.dn4$Cell_Tim3,g=3)
  full.dn4$TIM3.class<-'TIM3.low'
  table(full.dn4$TIM3.cut)
  full.dn4$TIM3.class[which(full.dn4$TIM3.cut=='[0.379,0.491)')]<-'TIM3.medium'
  full.dn4$TIM3.class[which(full.dn4$TIM3.cut=='[0.491,1.000]')]<-'TIM3.high'
 ##PDL1
  full.dn4$PDL1.cut<-cut2(full.dn4$Cell_PDL1,g=3)
  full.dn4$PDL1.class<-'PDL1.low'
   table(full.dn4$PDL1.cut)
  full.dn4$PDL1.class[which(full.dn4$PDL1.cut=='[0.291,0.364)')]<-'PDL1.medium'
  full.dn4$PDL1.class[which(full.dn4$PDL1.cut=='[0.364,1.000]')]<-'PDL1.high'

  full.dn4$PD1.cut<-cut2(full.dn4$Cell_PD1,g=3)
  full.dn4$PD1.class<-'PD1.low' 
  table(full.dn4$PD1.cut)
  full.dn4$PD1.class[which(full.dn4$PD1.cut=='[0.0895,0.1875)')]<-'PD1.medium'
  full.dn4$PD1.class[which(full.dn4$PD1.cut=='[0.189,1.000]')]<-'PD1.high'

 ##used for gating Highlysuppressive TREG.
  full.dn4$CCR4.cut<-cut2(full.dn4$Cell_CCR4,g=3)
  full.dn4$CCR4.class<-'CCR4.low'
  table(full.dn4$CCR4.cut)
  full.dn4$CCR4.class[which(full.dn4$CCR4.cut=='[0.439,0.538)')]<-'CCR4.medium' 
  full.dn4$CCR4.class[which(full.dn4$CCR4.cut=='[0.538,1.000]')]<-'CCR4.high'
 
 ##ICOS
  full.dn4$ICOS.cut<-cut2(full.dn4$Cell_ICOS,g=3)
  full.dn4$ICOS.class<-'ICOS.low'
  table(full.dn4$ICOS.cut)
  full.dn4$ICOS.class[which(full.dn4$ICOS.cut=='[0.0374,0.0934)')]<-'ICOS.medium' 
  full.dn4$ICOS.class[which(full.dn4$ICOS.cut=='[0.0934,1.0000]')]<-'ICOS.high'
 
 ## create a immune subset tag.
 full.dn4$immune.tag<-as.character(full.dn4$subType.correction)
 # TIM3/PDL1 co-express
 full.dn4$immune.tag[which(full.dn4$immune.tag=='Macrophage')]<-paste0(full.dn4$immune.tag[which(full.dn4$immune.tag=='Macrophage')],"_",full.dn4$TIM3.class[which(full.dn4$immune.tag=='Macrophage')],
	"_",full.dn4$PDL1.class[which(full.dn4$immune.tag=='Macrophage')])

 ##TIM3/PD1 coexpress on CD4/CD8
 full.dn4$immune.tag[which(full.dn4$immune.tag=='CD4')]<-paste0(full.dn4$immune.tag[which(full.dn4$immune.tag=='CD4')],"_",full.dn4$TIM3.class[which(full.dn4$immune.tag=='CD4')],
	"_",full.dn4$PD1.class[which(full.dn4$immune.tag=='CD4')])
 full.dn4$immune.tag[which(full.dn4$immune.tag=='CD8')]<-paste0(full.dn4$immune.tag[which(full.dn4$immune.tag=='CD8')],"_",full.dn4$TIM3.class[which(full.dn4$immune.tag=='CD8')],
	"_",full.dn4$PD1.class[which(full.dn4$immune.tag=='CD8')])

 ## TREG identify highly suppressive, and normal TREG.

 hst.id<-which(full.dn4$immune.tag=='TREG'&full.dn4$CCR4.class=='CCR4.high' & full.dn4$ICOS.class=='ICOS.high')
  full.dn4$immune.tag[hst.id]<-'HighlysuppressiveTREG'
full.dn4$immune.tag[which(full.dn4$immune.tag=='HighlysuppressiveTREG')]<-paste0(full.dn4$immune.tag[which(full.dn4$immune.tag=='HighlysuppressiveTREG')],
	"_",full.dn4$PD1.class[which(full.dn4$immune.tag=='HighlysuppressiveTREG')])
 ## TREG PD1+/med/-
 full.dn4$immune.tag[which(full.dn4$immune.tag=='TREG')]<-paste0(full.dn4$immune.tag[which(full.dn4$immune.tag=='TREG')],
	"_",full.dn4$PD1.class[which(full.dn4$immune.tag=='TREG')])

 
 dlbcl.dat_cells<-data.frame(ImageNumber=full.dn4$ROIID,
	ObjectNumber=full.dn4$CellId,
	label=as.character(full.dn4$immune.tag),
	group=full.dn4$ROIID)
  dlbcl.dat_cells<-data.table(dlbcl.dat_cells)

  dlbcl.dat_relation_15<-createRelationTable(dn5=full.dn4,
	myPheno="immune.tag",
	minDistance=15)

  save(dlbcl.dat_relation_15,file="dlbcl.dat_relation_15_immuneTAG.15distance.p025.RData")
 load("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/final-figure3-tables-figures-4-28/dlbcl.dat_relation_15_immuneTAG.15distance.p025.RData")

  
 ## using the p=0.025 threshold.
  dlbcl.p1<-makePermutationNBHD(dat_cells=dlbcl.dat_cells,
	dat_relation=dlbcl.dat_relation_15,
	n_perm=1000,
	pthreshold=0.025)
   save(dlbcl.p1,file="dlbcl.p1_15_immuneTAG.15distance.p025.RData")
 load("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/chl-spatial/dlbcl.p1_15_immuneTAG.15distance.p025.RData")
  

 load("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/final-figure3-tables-figures-4-28/p1_15_annotated.chl.immune.tag.15distance.025.RData")
  
 ## make the bar graph and perform the T-test.
 ## compare REF to CR TREG
   chlp<-p1$dat_p
   chlp$disease<-"HL"
   chlp$FirstLabel.B<-as.character(chlp$FirstLabel)
   chlp$SecondLabel.B<-as.character(chlp$SecondLabel)
   chlp$FirstLabel.B[which(chlp$FirstLabel.B=='CD30.HRS')]<-'Tumor'
   chlp$SecondLabel.B[which(chlp$SecondLabel.B=='CD30.HRS')]<-'Tumor'
  chlp$FirstLabel.B<-factor(as.character(chlp$FirstLabel.B))
  chlp$SecondLabel.B<-factor(as.character(chlp$SecondLabel.B))

  bct<-chlp[which(chlp$FirstLabel.B=='Tumor' & chlp$disease=='HL' & chlp$sigval>=0),]
  bct2<-bct
 bct<-bct%>%group_by(SecondLabel.B)%>%summarise(total=mean(sigval),SD=sd(sigval),N=n())%>%data.frame
  bct$tumor="HL"
  bct$SD<-bct$SD/sqrt(bct$N)
  bct$error<-qt(0.95,df=(bct$N-1))*bct$SD  
 bct<-bct[which(bct$SecondLabel.B!='Tumor' & bct$SecondLabel.B!='none'),]
 bct$Probability<-bct$total/sum(bct$total)
 bct$Expected<-bct$Probability* bct$N  


  ##DLBCL 
   dlbp<-dlbcl.p1$dat_p
   dlbp$disease<-"DLBCL"
   dlbp$FirstLabel.B<-as.character(dlbp$FirstLabel)
   dlbp$SecondLabel.B<-as.character(dlbp$SecondLabel)
  dlbp$FirstLabel.B[grepl("umor",dlbp$FirstLabel.B)]<-'Tumor'
   dlbp$SecondLabel.B[grepl("umor",dlbp$SecondLabel.B)]<-'Tumor'
  dlbp$FirstLabel.B<-factor(as.character(dlbp$FirstLabel.B))
  dlbp$SecondLabel.B<-factor(as.character(dlbp$SecondLabel.B))

  ##DLBCL enriched. 
  neg<-dlbp[which(dlbp$FirstLabel.B=='Tumor' & dlbp$disease=='DLBCL' & dlbp$sigval>=0),]
  neg2<-neg
  neg<-neg%>%group_by(SecondLabel.B)%>%summarise(total=mean(sigval),SD=sd(sigval),N=n())%>%data.frame
  neg$tumor="DLBCL"
  neg$SD<-neg$SD/sqrt(neg$N)
  neg$error<-qt(0.95,df=(neg$N-1))*neg$SD
  neg<-neg[which(neg$SecondLabel.B!='Tumor' & neg$SecondLabel.B!='none'),]
  neg$Probability<-neg$total/sum(neg$total)
 neg$Expected<-neg$Probability*neg$N  
 neg<-rbind(neg,NA,NA,NA,NA,NA)
   neg$SecondLabel.B<-as.character(neg$SecondLabel.B)
  neg$SecondLabel.B[which(is.na(neg$SecondLabel.B))]<-c("CD4_TIM3.high_PD1.medium",
	"CD4_TIM3.low_PD1.medium",
	"CD4_TIM3.medium_PD1.medium",
	"HighlysuppressiveTREG_PD1.medium",
	"TREG_PD1.medium")
	neg$tumor[which(is.na(neg$tumor))]<-'DLBCL'
	neg$total[which(is.na(neg$total))]<-0
 	neg$SD[which(is.na(neg$SD))]<-0
 	neg$N[which(is.na(neg$N))]<-41
	neg$error[which(is.na(neg$error))]<-0
 	neg$Probability[which(is.na(neg$Probability))]<-0
 	neg$Expected[which(is.na(neg$Expected))]<-0


  tumor.nbd<-rbind(bct,neg)
  tumor.nbd$lower<-tumor.nbd$Probability-tumor.nbd$error
  tumor.nbd$upper<-tumor.nbd$Probability+tumor.nbd$error
  tumor.nbd$Expected<-tumor.nbd$Probability*tumor.nbd$N
  tumor.nbd$lower[which(tumor.nbd$lower<0)]<-0
	##filtering.
   
 tumor.nbd<-tumor.nbd[!tumor.nbd$SecondLabel.B%in%c("CD8_TIM3.high_PD1.medium",
"CD8_TIM3.low_PD1.medium",
"CD8_TIM3.medium_PD1.medium",
 "HighlysuppressiveTREG_PD1.low",
 "Macrophage_TIM3.low_PDL1.medium"),]
	
  tumor.nbd$SecondLabel.B<-droplevels(tumor.nbd$SecondLabel.B)
	##drop both empty
 
  ## create Labels,
 ##need to facet wrap by primary phenotype.
 tumor.nbd$label<-as.character(tumor.nbd$SecondLabel.B)
 tumor.nbd$label<-gsub(".high","+",tumor.nbd$label)
 tumor.nbd$label<-gsub(".low","-",tumor.nbd$label)
 tumor.nbd$label<-gsub(".medium","mid",tumor.nbd$label)

 tumor.nbd2<-tumor.nbd[!grepl("medium",tumor.nbd$SecondLabel.B),]

 tumor.nbd2$label[which(!grepl("TREG",tumor.nbd2$label) & tumor.nbd2$label!='Endothelial')] <-sapply(strsplit(tumor.nbd2$label[which(!grepl("TREG",tumor.nbd2$label) & tumor.nbd2$label!='Endothelial')],"_"),function(x) paste0(x[2],x[3],x[1]))

  tumor.nbd2$label<-factor(tumor.nbd2$label,levels=c(
	"TIM3+PD1+CD4",
        "TIM3+PD1-CD4",             
         "TIM3-PD1+CD4",
         "TIM3-PD1-CD4" ,             
       "TIM3+PD1+CD8",
        "TIM3+PD1-CD8",              
         "TIM3-PD1+CD8",
         "TIM3-PD1-CD8", 
	"TIM3+PDL1+Macrophage", 
	"TIM3+PDL1-Macrophage", 
	"TIM3-PDL1+Macrophage",
	"TIM3-PDL1-Macrophage", 
	"HighlysuppressiveTREG_PD1+", 
	"TREG_PD1+",
	 "TREG_PD1-",      
  "Endothelial"))


  ggplot(tumor.nbd2,aes(x=label,y=100*Probability,fill=tumor))+geom_bar(stat='identity',position=position_dodge())+geom_errorbar(aes(ymin=100*lower,ymax=100*upper),position=position_dodge(),color='gray49')+scale_fill_manual(values=c("khaki2","pink2"))+theme_ipsum(base_family='Arial')+theme(axis.text.x=element_text(size=15,angle=65,hjust=1,colour='black'),
	axis.text.y=element_text(size=15,colour='black'),
	axis.title.x=element_text(size=12),
	axis.title.y=element_text(size=12))+ylab("Proportion with significant attraction (%)")
  

 ggsave("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/final-figure3-tables-figures-4-28/CR.vs.REF.tumor.NBHD.analysis.p025.png")


 

 ## Formatting 
   order.id<- order(tumor.nbd$total[which(tumor.nbd$tumor=='HL')]<tumor.nbd$total[which(tumor.nbd$tumor!='HL')])
 tumor.nbd$SecondLabel<-factor(tumor.nbd$SecondLabel,levels=as.character(tumor.nbd$SecondLabel[order.id]))
  


 tumor.nbd$label<-full.dn4$annotated.umap[match(tumor.nbd$SecondLabel,full.dn4$annotated.umap.simple)]

  tumor.nbd<-tumor.nbd[which(tumor.nbd$SecondLabel!='none'),]
  umapColors<-getPhenoColorsAnnotatedLabelUMAP(full.dn4)
 responderColors<-getResponderColors()
   tumor.nbd$label<-factor(tumor.nbd$label,levels=levels(full.dn4$annotated.umap))
  tumor.nbd$lower[which(tumor.nbd$lower<0)]<-0
 ggplot(tumor.nbd,aes(x=label,y=100*Probability,fill=tumor))+geom_bar(stat='identity',position=position_dodge())+geom_errorbar(aes(ymin=100*lower,ymax=100*upper),position=position_dodge(),color='gray49')+scale_fill_manual(values=c("darkslateblue","firebrick2"))+theme_ipsum(base_family='Arial')+theme(axis.text.x=element_text(size=15,angle=65,hjust=1,colour='black'),
	axis.text.y=element_text(size=15,colour='black'),
	axis.title.x=element_text(size=12),
	axis.title.y=element_text(size=12))+ylab("Proportion with significant attraction (%)")
   ggsave("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/final-figure3-tables-figures-4-28/CR.vs.REF.tumor.NBHD.analysis.p025.png")

 ## write this data to Figure 3 file.
  t.test(datp[datp$FirstLabel.B=='Tumor' & datp$SecondLabel.B=='HighlysuppressiveTreg' & datp$response=='CR','sigval'],datp[datp$FirstLabel.B=='Tumor' & datp$SecondLabel.B=='HighlysuppressiveTreg' & datp$response!='CR','sigval'])

 t.test(datp[datp$FirstLabel.B=='Tumor' & datp$SecondLabel.B=='PDL1_M2Macrophage' & datp$response=='CR','sigval'],datp[datp$FirstLabel.B=='Tumor' & datp$SecondLabel.B=='PDL1_M2Macrophage' & datp$response!='CR','sigval'])

 ## write out the data to Figure3 table.
 library(openxlsx)
 	  fig3<-openxlsx::loadWorkbook("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/final-figure3-tables-figures-4-28/Figure3.B.tableData-FINAL.xlsx")
	openxlsx::addWorksheet(fig3,"tumorNBHD.RF.v.CR.p025")
	openxlsx::writeData(fig3,'tumorNBHD.RF.v.CR.p025',
	tumor.nbd,
	rowNames=TRUE,withFilter=FALSE,colNames=TRUE,startCol=1,startRow=1)
	openxlsx::saveWorkbook(fig3,file="~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/final-figure3-tables-figures-4-28/Figure3.B.tableData-FINAL2.xlsx",overwrite=TRUE)






```



### looking at TIM-3 neighborhoods comparing DLBCL and HL
 I am searching for TME interactions or differential co-locality.
```{r, eval=FALSE}

load("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/chl-spatial/dlbcl.p1_15_immuneTAG.15distance.p025.RData")  

 load("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/final-figure3-tables-figures-4-28/p1_15_annotated.chl.immune.tag.15distance.025.RData")
  
 ## make the bar graph and perform the T-test.
 ## compare REF to CR TREG
   chlp<-p1$dat_p
   chlp$disease<-"HL"
   chlp$FirstLabel.B<-as.character(chlp$FirstLabel)
   chlp$SecondLabel.B<-as.character(chlp$SecondLabel)
   chlp$FirstLabel.B[which(chlp$FirstLabel.B=='CD30.HRS')]<-'Tumor'
   chlp$SecondLabel.B[which(chlp$SecondLabel.B=='CD30.HRS')]<-'Tumor'
  chlp$FirstLabel.B<-factor(as.character(chlp$FirstLabel.B))
  chlp$SecondLabel.B<-factor(as.character(chlp$SecondLabel.B))
 
 ## Let's look at TIM3 macrophages
  bct<-chlp[which(chlp$FirstLabel.B=="Macrophage_TIM3.high_PDL1.high" & chlp$sigval>=0 | chlp$FirstLabel.B=="Macrophage_TIM3.low_PDL1.high" & chlp$sigval>=0 ),]
  bct2<-bct
 bct<-bct%>%group_by(FirstLabel.B,SecondLabel.B)%>%summarise(total=mean(sigval),SD=sd(sigval),N=n())%>%data.frame
  bct$tumor="HL"
  bct$SD<-bct$SD/sqrt(bct$N)
  bct$error<-qt(0.95,df=(bct$N-1))*bct$SD  
 bct<-bct[which(bct$SecondLabel.B!='Tumor' & bct$SecondLabel.B!='none'),]
 bct$Probability<-bct$total/sum(bct$total)
 bct$Expected<-bct$Probability* bct$N  


  ##DLBCL 
   dlbp<-dlbcl.p1$dat_p
   dlbp$disease<-"DLBCL"
   dlbp$FirstLabel.B<-as.character(dlbp$FirstLabel)
   dlbp$SecondLabel.B<-as.character(dlbp$SecondLabel)
  dlbp$FirstLabel.B[grepl("umor",dlbp$FirstLabel.B)]<-'Tumor'
   dlbp$SecondLabel.B[grepl("umor",dlbp$SecondLabel.B)]<-'Tumor'
  dlbp$FirstLabel.B<-factor(as.character(dlbp$FirstLabel.B))
  dlbp$SecondLabel.B<-factor(as.character(dlbp$SecondLabel.B))

  ##DLBCL enriched. 
  neg<-dlbp[which(dlbp$FirstLabel.B=="Macrophage_TIM3.high_PDL1.high" & dlbp$sigval>=0 | dlbp$FirstLabel.B=="Macrophage_TIM3.low_PDL1.high" & dlbp$sigval>=0 ),]
  neg2<-neg
  neg<-neg%>%group_by(FirstLabel.B,SecondLabel.B)%>%summarise(total=mean(sigval),SD=sd(sigval),N=n())%>%data.frame
  neg$tumor="DLBCL"
  neg$SD<-neg$SD/sqrt(neg$N)
  neg$error<-qt(0.95,df=(neg$N-1))*neg$SD
  neg<-neg[which(neg$SecondLabel.B!='Tumor' & neg$SecondLabel.B!='none'),]
  neg$Probability<-neg$total/sum(neg$total)
 neg$Expected<-neg$Probability*neg$N  
 
  common<-intersect(neg$SecondLabel.B,bct$SecondLabel.B)
  neg<-neg[neg$SecondLabel.B%in%common,]
  bct<-bct[bct$SecondLabel.B%in%common,]
 
  tumor.nbd<-rbind(bct,neg)
  tumor.nbd$lower<-tumor.nbd$Probability-tumor.nbd$error
  tumor.nbd$upper<-tumor.nbd$Probability+tumor.nbd$error
  tumor.nbd$Expected<-tumor.nbd$Probability*tumor.nbd$N
  tumor.nbd$lower[which(tumor.nbd$lower<0)]<-0

	
 
  ## create Labels,
 ##need to facet wrap by primary phenotype.
 tumor.nbd$label<-as.character(tumor.nbd$SecondLabel.B)
 tumor.nbd$label<-gsub(".high","+",tumor.nbd$label)
 tumor.nbd$label<-gsub(".low","-",tumor.nbd$label)
 tumor.nbd$label<-gsub(".medium","mid",tumor.nbd$label)


  ggplot(tumor.nbd,aes(x=label,y=100*Probability,fill=tumor))+geom_bar(stat='identity',position=position_dodge())+geom_errorbar(aes(ymin=100*lower,ymax=100*upper),position=position_dodge(),color='gray49')+scale_fill_manual(values=c("khaki2","pink2"))+theme_ipsum(base_family='Arial')+theme(axis.text.x=element_text(size=15,angle=65,hjust=1,colour='black'),
	axis.text.y=element_text(size=15,colour='black'),
	axis.title.x=element_text(size=12),
	axis.title.y=element_text(size=12))+ylab("Proportion with significant attraction (%)")+facet_wrap(~FirstLabel.B)
  

 ggsave("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/final-figure3-tables-figures-4-28/CR.vs.REF.tumor.NBHD.analysis.p025.png")


 

 ## Formatting 
   order.id<- order(tumor.nbd$total[which(tumor.nbd$tumor=='HL')]<tumor.nbd$total[which(tumor.nbd$tumor!='HL')])
 tumor.nbd$SecondLabel<-factor(tumor.nbd$SecondLabel,levels=as.character(tumor.nbd$SecondLabel[order.id]))
  


 tumor.nbd$label<-full.dn4$annotated.umap[match(tumor.nbd$SecondLabel,full.dn4$annotated.umap.simple)]

  tumor.nbd<-tumor.nbd[which(tumor.nbd$SecondLabel!='none'),]
  umapColors<-getPhenoColorsAnnotatedLabelUMAP(full.dn4)
 responderColors<-getResponderColors()
   tumor.nbd$label<-factor(tumor.nbd$label,levels=levels(full.dn4$annotated.umap))
  tumor.nbd$lower[which(tumor.nbd$lower<0)]<-0
 ggplot(tumor.nbd,aes(x=label,y=100*Probability,fill=tumor))+geom_bar(stat='identity',position=position_dodge())+geom_errorbar(aes(ymin=100*lower,ymax=100*upper),position=position_dodge(),color='gray49')+scale_fill_manual(values=c("darkslateblue","firebrick2"))+theme_ipsum(base_family='Arial')+theme(axis.text.x=element_text(size=15,angle=65,hjust=1,colour='black'),
	axis.text.y=element_text(size=15,colour='black'),
	axis.title.x=element_text(size=12),
	axis.title.y=element_text(size=12))+ylab("Proportion with significant attraction (%)")
   ggsave("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/final-figure3-tables-figures-4-28/CR.vs.REF.tumor.NBHD.analysis.p025.png")

 ## write this data to Figure 3 file.
  t.test(datp[datp$FirstLabel.B=='Tumor' & datp$SecondLabel.B=='HighlysuppressiveTreg' & datp$response=='CR','sigval'],datp[datp$FirstLabel.B=='Tumor' & datp$SecondLabel.B=='HighlysuppressiveTreg' & datp$response!='CR','sigval'])

 t.test(datp[datp$FirstLabel.B=='Tumor' & datp$SecondLabel.B=='PDL1_M2Macrophage' & datp$response=='CR','sigval'],datp[datp$FirstLabel.B=='Tumor' & datp$SecondLabel.B=='PDL1_M2Macrophage' & datp$response!='CR','sigval'])

 ## write out the data to Figure3 table.
 library(openxlsx)
 	  fig3<-openxlsx::loadWorkbook("~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/final-figure3-tables-figures-4-28/Figure3.B.tableData-FINAL.xlsx")
	openxlsx::addWorksheet(fig3,"tumorNBHD.RF.v.CR.p025")
	openxlsx::writeData(fig3,'tumorNBHD.RF.v.CR.p025',
	tumor.nbd,
	rowNames=TRUE,withFilter=FALSE,colNames=TRUE,startCol=1,startRow=1)
	openxlsx::saveWorkbook(fig3,file="~/Documents/imageAnalysis/DLBCL/simpleModel-1-14/final-submission-folder/final-figure3-tables-figures-4-28/Figure3.B.tableData-FINAL2.xlsx",overwrite=TRUE)


```






